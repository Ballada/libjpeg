/* target information */
@import "version.inc";

#product-info  {
    product-name: "libjpeg";
    version: "8c";
    original-source-location: "http://ijg.org/files/jpegsr8c.zip";
    original-source-website: "http://ijg.org";
    license: "Custom license, see README";
    packager: "Rafael Rivera <rafael@withinwindows.com>";
}
 

test {
    default : false;
    uses: release;
    build-command: @"
	    rem";
};

package {
    
    default : false;
    uses : sign;
    
    targets: { 
        @"copkg\libjpeg[vc10]-${package-version}-x86.msi",
        @"copkg\libjpeg-dev[vc10]-${package-version}-x86.msi",
        @"copkg\libjpeg-dev-common-${package-version}-any.msi",
        @"copkg\libjpeg[vc10]-${package-version}-x64.msi",
        @"copkg\libjpeg-dev[vc10]-${package-version}-x64.msi"
    };
    
    build-command : @"
        REM THERE IS SOME GOOFY STUFF IN HERE TO WORK AROUND A COUPLE BUGS IN AUTOPACKAGE.
        REM FIXES COMING SOON...
        cd COPKG
        coapp add-feed %cd%\
        coapp --force-scan list 
        autopackage libjpeg-dev-common.autopkg || goto failed
        coapp --force-scan list 
        autopackage libjpeg[vc10]-x86.autopkg libjpeg-dev[vc10]-x86.autopkg || goto failed
        coapp --force-scan list 
        autopackage libjpeg[vc10]-x64.autopkg libjpeg-dev[vc10]-x64.autopkg || goto failed
        coapp --force-scan list 
        coapp delete-feed %cd%\
        ptk update-version
    ";

	clean-command: @"del COPKG\*.msi COPKG\*.wixpdb";
	
};


update-version {
    default : false;
    
    build-command : @"
        REM auto-increment version.inc file...
        
        cd COPKG
        setlocal EnableDelayedExpansion
        for /F ""tokens=4,5,6,7  delims=.; "" %%v in (version.inc) do (
            set /a build=%%y + 1
            set VERSTRING=#define { package-version: %%v.%%w.%%x.!build!; }
        )
        echo !VERSTRING! > version.inc
    ";
}

release {
    set: BuildCfg="Release";
    uses: x86;
    uses: x64;
};

sign {
    default : false;
    uses: release;
    build-command: @"simplesigner.exe --nologo --sign output\vc10\x86\Release\bin**.dll output\vc10\x86\Release\bin\**.exe output\vc10\x64\Release\bin\**.dll output\vc10\x64\Release\bin\**.exe";
};


x86 {
    compiler: vc10;
    platform: x86;
     
    targets: { 
        // main library
        "output\vc10\x86\Release\bin\jpeg.lib",
        "output\vc10\x86\Release\bin\jpegs.lib",
        "output\vc10\x86\Release\bin\jpeg.dll",                
        // extra utilities
        "output\vc10\x86\Release\bin\cjpeg.exe",
        "output\vc10\x86\Release\bin\djpeg.exe",
        "output\vc10\x86\Release\bin\jpegtran.exe",
        "output\vc10\x86\Release\bin\rdjpgcom.exe",
        "output\vc10\x86\Release\bin\wrjpgcom.exe",
    };
     
    build-command:@"
        copy jconfig.vc jconfig.h       
        copy makejsln.v10 makejsln.sln
        copy makeasln.v10 makeasln.sln
        copy makejvcx.v10 jpeg.vcxproj
        copy makelvcx.v10 jpegdll.vcxproj
        copy makecvcx.v10 cjpeg.vcxproj
        copy makedvcx.v10 djpeg.vcxproj
        copy maketvcx.v10 jpegtran.vcxproj
        copy makewvcx.v10 wrjpgcom.vcxproj
        copy makervcx.v10 rdjpgcom.vcxproj
        msbuild /p:Platform=Win32 /p:Configuration=Release makejsln.sln
        msbuild /p:Platform=Win32 /p:Configuration=Release makeasln.sln
    ";
     
    clean-command:@"
        attrib -S -H -R *
        del /Q *.sdf *.suo *.sln *.vcxproj *.user jconfig.h 2>NUL
        rmdir /S /Q output 2>NUL
    ";
};

x64 {
    compiler: vc10;
    platform: x64;
     
    targets: { 
        // main library
        "output\vc10\x64\Release\bin\jpeg.lib",
        "output\vc10\x64\Release\bin\jpegs.lib",
        "output\vc10\x64\Release\bin\jpeg.dll",        
        // extra utilities
        "output\vc10\x64\Release\bin\cjpeg.exe",
        "output\vc10\x64\Release\bin\djpeg.exe",
        "output\vc10\x64\Release\bin\jpegtran.exe",
        "output\vc10\x64\Release\bin\rdjpgcom.exe",
        "output\vc10\x64\Release\bin\wrjpgcom.exe",
    };
     
    build-command:@"
        copy jconfig.vc jconfig.h       
        copy makejsln.v10 makejsln.sln
        copy makeasln.v10 makeasln.sln
        copy makejvcx.v10 jpeg.vcxproj
        copy makelvcx.v10 jpegdll.vcxproj
        copy makecvcx.v10 cjpeg.vcxproj
        copy makedvcx.v10 djpeg.vcxproj
        copy maketvcx.v10 jpegtran.vcxproj
        copy makewvcx.v10 wrjpgcom.vcxproj
        copy makervcx.v10 rdjpgcom.vcxproj
        msbuild /p:Platform=x64 /p:Configuration=Release makejsln.sln
        msbuild /p:Platform=x64 /p:Configuration=Release makeasln.sln
    ";
     
    clean-command:@"
        attrib -S -H -R *
        del /Q *.sdf *.suo *.sln *.vcxproj *.user jconfig.h 2>NUL
        rmdir /S /Q output 2>NUL
    ";
};